# Aria2

## 第一部分: 基础

### 公网IP

在没有公网 IP 的情况下其它的 BT 客户端很难发现你的存在，只有你去发现别人，所以这大大削弱了你的 BT  
客户端的资源搜寻能力。 现在基本上运营都不会主动给家庭宽带分配公网 IP 。但这并不代表你不能获得公网  
IP，你所要做的是向运营商提出要求，若不满足可以尝试投诉。

### 开放监听端口

```
# BT 监听端口(TCP), 默认:6881-6999
listen-port=6888
# DHT 网络与 UDP tracker 监听端口(UDP), 默认:6881-6999
dht-listen-port=6888
```

* 直通外网的设备，比如 VPS ，务必配置防火墙和安全组策略允许此端口入站
* 内网环境的设备，比如 NAS ，除了防火墙设置，还需在**路由器设置外网端口转发到此端口**(aria2不支持UPnP)
* DHT使用UDP协议，BT 使用 TCP 协议，两者可以使用相同的端口，方便配置防火墙和端口转发策略。

### 添加 BitTorrent tracker

Bit­Tor­rent tracker 是帮助 BT 协议在节点与节点之间做连接的服务器，俗称 BT 服务器、tracker 服务器以  
下简称为 tracker ）。BT 下载一开始就要连接到 tracker ，从 tracker 获得其他客户端 IP 地址后，才能连  
接到其他客户端下载。在传输过程中，也会一直与 tracker 通信，上传自己的信息，获取其它客户端的信息。  
所以 tracker 在 BT 下载中起到了至关重要的作用。

每个 BT 种子都会内置 tracker ，但可能因为不可抗力而导致连接困难或者速度不理想，这就意味着很难找到下  
载相同资源的人。好在这个问题可以通过添加额外 tracker 来解决，这样你遇到和你下载同样资源的人的机会就  
更多，就更容易找到给你上传的人，速度自然就会快了。

### 获取 DHT 网络节点数据

由于 tracker 对 BT 下载起到客户端协调和调控的重要作用，所以一旦被封锁会严重影响 BT 下载。早年中国大  
陆对 tracker 的封锁曾一度导致 BT 下载销声匿迹，这也促使了 DHT 网络的诞生。

DHT 网络由无数节点组成，只要是开启 DHT 功能的 BT 客户端都是一个节点，所以你也可以是其中的一份子。当  
接触到一个节点，通过这个节点又能接触到更多的节点，接触的节点越多，你获取资源的能力就越强，下载的速度  
间接也就会有提升。即使在完全不连上 Tracker 服务器的情况下，也可以很好的下载。

此外磁力链接是完全依赖于 DHT 网络的，所以如果你没办法成功连接到 DHT 节点，那么是完全无法进行下载的。  
所以这也是为什么有些小伙伴使用种子能下载，而磁力链接完全无法下载的原因之一。

以下是 Aria2 配置文件中一些与 DHT 相关的主要功能选项：

```
# DHT 网络监听端口(UDP), 默认:6881-6999
dht-listen-port=51413

# 启用 IPv4 DHT 功能, PT 下载(私有种子)会自动禁用, 默认:true
enable-dht=true

# 启用 IPv6 DHT 功能, PT 下载(私有种子)会自动禁用，默认:false
# 在没有 IPv6 支持的环境开启可能会导致 DHT 功能异常
enable-dht6=false

# IPv4 DHT 文件路径，默认：$HOME/.aria2/dht.dat
dht-file-path=/root/.aria2/dht.dat

# IPv6 DHT 文件路径，默认：$HOME/.aria2/dht6.dat
dht-file-path6=/root/.aria2/dht6.dat
```

Aria2 有个 dht.dat 文件（开启 IPv6 还有个 dht6.dat），里面记录了 DHT 网络节点信息。但是！文件本身是  
不存在的，需要手动创建。如果你在没有对 Aria2 进行任何配置的情况下第一次运行时直接下载磁力链接或者冷  
门种子，会因为文件内没有任何数据，就无法获取到 DHT 网络中的节点，所以就会遇到无法下载的情况。

第一个解决方案是找有数据 DHT 文件。比如 Aria2 完美配置中就有。使用 Aria2 一键安装脚本 增强版和 Aria2  
Pro 的小伙伴就无需折腾了，因为博主已经贴心的帮你们整合好了。

第二个解决方案是生成 DHT 数据。找几个热门种子下载，比如 Ubuntu 镜像的种子，全球每天有成千上万的人在同  
时下载。下载并做种几个小时，你会发现 dht.dat 从空文件变成有数据了。

### UDP 受限

BT 下载部分通讯使用的是 UDP 协议。由于 BT 下载占用了很大的带宽，所以运营商会干扰 UDP 协议，从而导致  
BT 下载出现问题。这在早期 BT 下载还未使用加密通讯时尤其严重。目前来说只要你开启加密选项，那么就可以  
在一定程度上避免这个情况。

## Aria2 Docker 的使用

## References

* [原文出处](https://p3terx.com/archives/solved-aria2-cant-download-magnetic-link-bt-seed-and-slow-speed.html)
